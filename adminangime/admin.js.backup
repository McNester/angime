// Admin Panel JavaScript - Modern Version with Video Support
// Login credentials
const ADMIN_USERNAME = 'arseblan';
const ADMIN_PASSWORD = 'yakonch2026';
const ADMIN_PASSWORD = 'yakonch2026';

let menuData = null;
let currentCategory = null;
let currentEditingItem = null;
let hasUnsavedChanges = false;
let currentImages = [];
let currentVideos = [];

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    initLogin();
    initAdmin();
});

// Login functionality
function initLogin() {
    const loginScreen = document.getElementById('loginScreen');
    const adminPanel = document.getElementById('adminPanel');
    const usernameInput = document.getElementById('usernameInput');    const loginBtn = document.getElementById('loginBtn');
    const usernameInput = document.getElementById('usernameInput');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginError = document.getElementById('loginError');

    // Check if already logged in
    if (localStorage.getItem('adminLoggedIn') === 'true') {
        loginScreen.style.display = 'none';
        adminPanel.style.display = 'flex';
        loadMenuData();
        return;
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            localStorage.setItem('adminLoggedIn', 'true');
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'flex';
            loadMenuData();
        } else {
            loginError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            usernameInput.value = '';
            passwordInput.value = '';
    // Enter key support
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            passwordInput.focus();
        }
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });        }
    });

    // Enter key support
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            passwordInput.focus();
        }
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });
}

// Logout
document.getElementById('logoutBtn')?.addEventListener('click', () => {
    localStorage.removeItem('adminLoggedIn');
    location.reload();
});

// Load menu data
function loadMenuData() {
    const menuJsonPath = window.location.pathname.includes('/adminangime') 
        ? '/menu.json' 
        : '../menu.json';
    
    fetch(menuJsonPath)
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('menu.json not found');
        })
        .then(data => {
            menuData = data.menu || data;
            renderAdmin();
        })
        .catch(() => {
            menuData = JSON.parse(JSON.stringify(CONFIG.menu));
            renderAdmin();
        });
}

// Render admin interface
function renderAdmin() {
    renderCategories();
    updateStats();
    updateStatus('–ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
}

// Render categories in sidebar
function renderCategories() {
    const categoriesList = document.getElementById('categoriesList');
    categoriesList.innerHTML = '';

    menuData.categories.forEach((category, index) => {
        const item = document.createElement('div');
        item.className = `category-item ${index === 0 ? 'active' : ''}`;
        item.textContent = getCategoryTitle(category);
        item.addEventListener('click', () => selectCategory(category, index));
        categoriesList.appendChild(item);
    });

    // Select first category by default
    if (menuData.categories.length > 0) {
        selectCategory(menuData.categories[0], 0);
    }
}

// Get category title
function getCategoryTitle(category) {
    if (typeof TRANSLATIONS !== 'undefined' && TRANSLATIONS.ru) {
        return TRANSLATIONS.ru[category.titleKey] || category.titleKey;
    }
    return category.titleKey;
}

// Select category
function selectCategory(category, index) {
    currentCategory = { category, index };
    
    // Update sidebar
    document.querySelectorAll('.category-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });

    // Update header
    document.getElementById('currentCategoryTitle').textContent = getCategoryTitle(category);
    document.getElementById('addItemBtn').style.display = 'flex';

    // Render items
    renderItems(category.items);
    updateStats();
}

// Render items grid
function renderItems(items) {
    const itemsGrid = document.getElementById('itemsGrid');
    
    if (items.length === 0) {
        itemsGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <p>–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>
            </div>
        `;
        return;
    }

    itemsGrid.innerHTML = '';

    items.forEach((item, itemIndex) => {
        const itemCard = createItemCard(item, itemIndex);
        itemsGrid.appendChild(itemCard);
    });
}

// Create item card
function createItemCard(item, itemIndex) {
    const card = document.createElement('div');
    card.className = 'item-card';

    const imageSrc = item.images && item.images.length > 0 
        ? item.images[0] 
        : 'https://placehold.co/400x300/667eea/ffffff?text=No+Image';

    const nameRu = getTranslation(item.nameKey, 'ru') || item.nameKey;
    const descRu = item.descKey ? (getTranslation(item.descKey, 'ru') || '') : '';

    card.innerHTML = `
        <img src="${imageSrc}" alt="${nameRu}" class="item-card-image" onerror="this.src='https://placehold.co/400x300/667eea/ffffff?text=Error'">
        <div class="item-card-content">
            <div class="item-card-header">
                <h3 class="item-card-name">${nameRu}</h3>
                <span class="item-card-price">${item.price}</span>
            </div>
            <p class="item-card-description">${descRu}</p>
            <div class="item-card-specs">
                ${item.specs ? item.specs.map(spec => `<span class="spec-badge">${spec}</span>`).join('') : ''}
            </div>
            <div class="item-card-actions">
                <button class="btn btn-primary btn-small" onclick="editItem(${itemIndex})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger btn-small" onclick="deleteItem(${itemIndex})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `;

    return card;
}

// Get translation
function getTranslation(key, lang = 'ru') {
    if (typeof TRANSLATIONS !== 'undefined' && TRANSLATIONS[lang]) {
        return TRANSLATIONS[lang][key];
    }
    return null;
}

// Edit item
function editItem(itemIndex) {
    const item = currentCategory.category.items[itemIndex];
    currentEditingItem = { item, itemIndex };

    // Reset media arrays
    currentImages = item.images ? [...item.images] : [];
    currentVideos = item.videos ? [...item.videos] : [];

    // Populate form
    document.getElementById('nameRu').value = getTranslation(item.nameKey, 'ru') || '';
    document.getElementById('nameKk').value = getTranslation(item.nameKey, 'kk') || '';
    document.getElementById('nameEn').value = getTranslation(item.nameKey, 'en') || '';
    document.getElementById('price').value = item.price || '';
    document.getElementById('descRu').value = item.descKey ? (getTranslation(item.descKey, 'ru') || '') : '';
    document.getElementById('descKk').value = item.descKey ? (getTranslation(item.descKey, 'kk') || '') : '';
    document.getElementById('descEn').value = item.descKey ? (getTranslation(item.descKey, 'en') || '') : '';
    document.getElementById('specs').value = item.specs ? item.specs.join(', ') : '';
    document.getElementById('details').value = item.details ? JSON.stringify(item.details, null, 2) : '';

    // Render media previews
    renderImagePreviews();
    renderVideoPreviews();

    // Show modal
    document.getElementById('itemModal').classList.add('active');
    document.getElementById('modalTitle').innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é
    `;
}

// Add new item
function addNewItem() {
    currentEditingItem = { item: null, itemIndex: -1 };
    currentImages = [];
    currentVideos = [];

    // Clear form
    document.getElementById('itemForm').reset();
    renderImagePreviews();
    renderVideoPreviews();

    document.getElementById('modalTitle').innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
    `;

    // Show modal
    document.getElementById('itemModal').classList.add('active');
}

// Delete item
function deleteItem(itemIndex) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é?')) {
        return;
    }

    currentCategory.category.items.splice(itemIndex, 1);
    renderItems(currentCategory.category.items);
    updateStats();
    markAsChanged();
}

// Save item
function saveItem(formData) {
    const nameRu = formData.nameRu.value.trim();
    if (!nameRu || !formData.price.value.trim()) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∑–≤–∞–Ω–∏–µ (RU) –∏ –¶–µ–Ω–∞');
        return;
    }

    // Generate keys
    const nameKey = currentEditingItem.item?.nameKey || generateKey('item', 'Name');
    const descKey = currentEditingItem.item?.descKey || generateKey('item', 'Desc');

    // Parse specs
    const specs = formData.specs.value
        .split(',')
        .map(s => s.trim())
        .filter(s => s.length > 0);

    // Parse details
    let details = null;
    if (formData.details.value.trim()) {
        try {
            details = JSON.parse(formData.details.value);
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –¥–ª—è –¥–µ—Ç–∞–ª–µ–π. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            return;
        }
    }

    // Create/update item
    const item = {
        nameKey,
        price: formData.price.value.trim(),
        descKey: (formData.descRu.value.trim() || formData.descKk.value.trim() || formData.descEn.value.trim()) ? descKey : undefined,
        specs: specs.length > 0 ? specs : [],
        images: currentImages.length > 0 ? currentImages : [],
        ...(currentVideos.length > 0 && { videos: currentVideos }),
        ...(details && { details })
    };

    // Update translations
    updateTranslations(nameKey, {
        ru: formData.nameRu.value.trim(),
        kk: formData.nameKk.value.trim(),
        en: formData.nameEn.value.trim()
    });

    if (formData.descRu.value.trim()) {
        updateTranslations(descKey, {
            ru: formData.descRu.value.trim(),
            kk: formData.descKk.value.trim(),
            en: formData.descEn.value.trim()
        });
    }

    // Add or update item
    if (currentEditingItem.itemIndex === -1) {
        currentCategory.category.items.push(item);
    } else {
        currentCategory.category.items[currentEditingItem.itemIndex] = item;
    }

    renderItems(currentCategory.category.items);
    updateStats();
    closeModal();
    markAsChanged();
}

// Generate unique key
function generateKey(prefix, suffix) {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000);
    return `${prefix}${timestamp}${random}${suffix}`;
}

// Update translations
let translationsData = {};

function updateTranslations(key, translations) {
    if (!translationsData[key]) {
        translationsData[key] = {};
    }
    Object.assign(translationsData[key], translations);
}

// Initialize admin
function initAdmin() {
    // Add item button
    document.getElementById('addItemBtn')?.addEventListener('click', addNewItem);

    // Modal handlers
    document.getElementById('modalClose')?.addEventListener('click', closeModal);
    document.getElementById('cancelBtn')?.addEventListener('click', closeModal);

    // Form submit
    document.getElementById('itemForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        saveItem(e.target);
    });

    // Save button
    document.getElementById('saveBtn')?.addEventListener('click', saveToFile);

    // Export button
    document.getElementById('exportBtn')?.addEventListener('click', exportJSON);

    // Close modal on background click
    document.getElementById('itemModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'itemModal') {
            closeModal();
        }
    });

    // Image upload
    initImageUpload();
    
    // Video upload
    initVideoUpload();
}

// Initialize image upload with drag-and-drop
function initImageUpload() {
    const uploadZone = document.getElementById('imageUploadZone');
    const fileInput = document.getElementById('imageFileInput');

    // Click to select files
    uploadZone.addEventListener('click', () => fileInput.click());

    // File input change
    fileInput.addEventListener('change', (e) => {
        handleImageFiles(Array.from(e.target.files));
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--accent-gold)';
        uploadZone.style.background = 'rgba(255, 215, 0, 0.1)';
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.style.borderColor = 'var(--border-color)';
        uploadZone.style.background = 'rgba(255, 255, 255, 0.02)';
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = 'var(--border-color)';
        uploadZone.style.background = 'rgba(255, 255, 255, 0.02)';
        
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        handleImageFiles(files);
    });
}

// Handle image files
function handleImageFiles(files) {
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            // For now, we'll use the file name as path
            // In production, you'd upload to server and get URL
            const imagePath = `pictures/–æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—é/${file.name}`;
            currentImages.push(imagePath);
            renderImagePreviews();
            markAsChanged();
        };
        reader.readAsDataURL(file);
    });
}

// Render image previews
function renderImagePreviews() {
    const grid = document.getElementById('imagePreviewGrid');
    grid.innerHTML = '';

    currentImages.forEach((imagePath, index) => {
        const item = document.createElement('div');
        item.className = 'media-preview-item';
        item.innerHTML = `
            <img src="${imagePath}" alt="Preview" onerror="this.src='https://placehold.co/150x150/667eea/ffffff?text=Error'">
            <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
        `;
        grid.appendChild(item);
    });
}

// Remove image
function removeImage(index) {
    currentImages.splice(index, 1);
    renderImagePreviews();
    markAsChanged();
}

// Initialize video upload
function initVideoUpload() {
    const addVideoBtn = document.getElementById('addVideoBtn');
    const videoUrlInput = document.getElementById('videoUrl');

    addVideoBtn.addEventListener('click', () => {
        const url = videoUrlInput.value.trim();
        if (url) {
            currentVideos.push(url);
            videoUrlInput.value = '';
            renderVideoPreviews();
            markAsChanged();
        }
    });

    videoUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addVideoBtn.click();
        }
    });
}

// Render video previews
function renderVideoPreviews() {
    const grid = document.getElementById('videoPreviewGrid');
    grid.innerHTML = '';

    currentVideos.forEach((videoPath, index) => {
        const item = document.createElement('div');
        item.className = 'media-preview-item';
        item.innerHTML = `
            <video src="${videoPath}" controls></video>
            <button class="remove-btn" onclick="removeVideo(${index})">&times;</button>
        `;
        grid.appendChild(item);
    });
}

// Remove video
function removeVideo(index) {
    currentVideos.splice(index, 1);
    renderVideoPreviews();
    markAsChanged();
}

// Close modal
function closeModal() {
    document.getElementById('itemModal').classList.remove('active');
    currentEditingItem = null;
    currentImages = [];
    currentVideos = [];
}

// Mark as changed
function markAsChanged() {
    hasUnsavedChanges = true;
    document.getElementById('unsavedIndicator').style.display = 'flex';
    updateStatus('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è');
}

// Update status
function updateStatus(message) {
    document.getElementById('statusText').textContent = message;
}

// Update stats
function updateStats() {
    if (!currentCategory) return;
    const total = currentCategory.category.items.length;
    document.getElementById('totalItems').textContent = total;
}

// Save to file
function saveToFile() {
    if (!menuData) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return;
    }

    const dataToSave = {
        menu: menuData,
        translations: translationsData,
        updatedAt: new Date().toISOString()
    };

    const json = JSON.stringify(dataToSave, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'menu.json';
    a.click();
    URL.revokeObjectURL(url);

    hasUnsavedChanges = false;
    document.getElementById('unsavedIndicator').style.display = 'none';
    updateStatus('–ú–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ menu.json. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ FTP/GitHub.');
}

// Export JSON
function exportJSON() {
    if (!menuData) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const json = JSON.stringify(menuData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'menu-export.json';
    a.click();
    URL.revokeObjectURL(url);

    updateStatus('JSON —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
}

// Make functions global for onclick handlers
window.editItem = editItem;
window.deleteItem = deleteItem;
window.removeImage = removeImage;
window.removeVideo = removeVideo;
